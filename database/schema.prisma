// Prisma Schema for MyVlog

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 用户模型
model User {
  id            BigInt    @id @default(autoincrement())
  username      String    @unique @db.VarChar(50)
  email         String    @unique @db.VarChar(100)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  nickname      String?   @db.VarChar(50)
  avatar        String?   @db.VarChar(255)
  role          UserRole  @default(USER)
  status        UserStatus @default(ACTIVE)
  vipExpireAt   DateTime? @map("vip_expire_at")
  lastLoginAt   DateTime? @map("last_login_at")
  lastLoginIp   String?   @map("last_login_ip") @db.VarChar(45)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // 关联
  articles      Article[]
  comments      Comment[]
  attachments   Attachment[]
  orders        Order[]
  operationLogs OperationLog[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  VIP
}

enum UserStatus {
  ACTIVE
  BANNED
  INACTIVE
}

// 分类模型
model Category {
  id          BigInt   @id @default(autoincrement())
  name        String   @db.VarChar(50)
  slug        String   @unique @db.VarChar(50)
  description String?  @db.VarChar(255)
  parentId    BigInt?  @map("parent_id")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  articles    Article[]

  @@map("categories")
}

// 标签模型
model Tag {
  id        BigInt   @id @default(autoincrement())
  name      String   @unique @db.VarChar(50)
  slug      String   @unique @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联
  articles  ArticleTag[]

  @@map("tags")
}

// 文章模型
model Article {
  id           BigInt    @id @default(autoincrement())
  title        String    @db.VarChar(255)
  slug         String    @unique @db.VarChar(255)
  summary      String?   @db.VarChar(500)
  content      String    @db.LongText // Markdown content
  coverImage   String?   @map("cover_image") @db.VarChar(255)
  authorId     BigInt    @map("author_id")
  categoryId   BigInt?   @map("category_id")
  status       ArticleStatus @default(DRAFT)
  visibility   Visibility @default(PUBLIC)
  price        Decimal   @default(0.00) @db.Decimal(10, 2)
  password     String?   @db.VarChar(50)
  isTop        Boolean   @default(false) @map("is_top")
  allowComment Boolean   @default(true) @map("allow_comment")
  viewCount    Int       @default(0) @map("view_count")
  likeCount    Int       @default(0) @map("like_count")
  commentCount Int       @default(0) @map("comment_count")
  wordCount    Int       @default(0) @map("word_count")
  readingTime  Int       @default(0) @map("reading_time") // in minutes
  publishedAt  DateTime? @map("published_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // 关联
  author       User      @relation(fields: [authorId], references: [id])
  category     Category? @relation(fields: [categoryId], references: [id])
  tags         ArticleTag[]
  comments     Comment[]

  @@index([authorId])
  @@index([categoryId])
  @@index([status])
  @@index([publishedAt])
  @@fulltext([title, content, summary]) // 注意：Fulltext search only works on MyISAM or InnoDB (MySQL 5.6+)
  @@map("articles")
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
}

enum Visibility {
  PUBLIC
  VIP
  PAID
  PASSWORD
  PRIVATE
}

// 文章-标签关联表 (Many-to-Many explicit)
model ArticleTag {
  articleId BigInt @map("article_id")
  tagId     BigInt @map("tag_id")

  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
  @@map("article_tags")
}

// 评论模型
model Comment {
  id          BigInt   @id @default(autoincrement())
  articleId   BigInt   @map("article_id")
  userId      BigInt?  @map("user_id")
  parentId    BigInt?  @map("parent_id")
  content     String   @db.Text
  guestName   String?  @map("guest_name") @db.VarChar(50)
  guestEmail  String?  @map("guest_email") @db.VarChar(100)
  guestUrl    String?  @map("guest_url") @db.VarChar(255)
  status      CommentStatus @default(PENDING)
  isAdmin     Boolean  @default(false) @map("is_admin")
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联
  article     Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])
  parent      Comment? @relation("CommentHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Comment[] @relation("CommentHierarchy")

  @@index([articleId])
  @@index([userId])
  @@map("comments")
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM
}

// 友情链接
model FriendLink {
  id          BigInt   @id @default(autoincrement())
  name        String   @db.VarChar(50)
  url         String   @db.VarChar(255)
  logo        String?  @db.VarChar(255)
  description String?  @db.VarChar(255)
  status      LinkStatus @default(ACTIVE)
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("friend_links")
}

enum LinkStatus {
  ACTIVE
  HIDDEN
}

// 系统配置
model SystemConfig {
  key         String   @id @db.VarChar(50)
  value       String   @db.Text
  type        String   @default("text") @db.VarChar(20)
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

// 附件/图床
model Attachment {
  id           BigInt   @id @default(autoincrement())
  userId       BigInt   @map("user_id")
  originalName String   @map("original_name") @db.VarChar(255)
  filePath     String   @map("file_path") @db.VarChar(255)
  fileUrl      String   @map("file_url") @db.VarChar(255)
  fileType     String   @map("file_type") @db.VarChar(50)
  fileSize     BigInt   @map("file_size")
  storageType  String   @default("local") @map("storage_type") @db.VarChar(20)
  createdAt    DateTime @default(now()) @map("created_at")

  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("attachments")
}

// 邮件订阅
model Subscriber {
  id          BigInt   @id @default(autoincrement())
  email       String   @unique @db.VarChar(100)
  isVerified  Boolean  @default(false) @map("is_verified")
  verifyToken String?  @map("verify_token") @db.VarChar(100)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("subscribers")
}

// Webhooks
model Webhook {
  id        BigInt   @id @default(autoincrement())
  event     String   @db.VarChar(50)
  targetUrl String   @map("target_url") @db.VarChar(255)
  secret    String?  @db.VarChar(100)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("webhooks")
}

// 订单 (为未来付费功能准备)
model Order {
  id            BigInt      @id @default(autoincrement())
  orderNo       String      @unique @map("order_no") @db.VarChar(50)
  userId        BigInt      @map("user_id")
  amount        Decimal     @db.Decimal(10, 2)
  status        OrderStatus @default(PENDING)
  paymentMethod String?     @map("payment_method") @db.VarChar(20) // alipay, wechat, paypal
  paidAt        DateTime?   @map("paid_at")
  productType   ProductType @map("product_type")
  productId     BigInt      @map("product_id")
  tradeNo       String?     @map("trade_no") @db.VarChar(100)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  user          User        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([orderNo])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum ProductType {
  VIP
  ARTICLE
}

// 操作日志
model OperationLog {
  id          BigInt   @id @default(autoincrement())
  userId      BigInt?  @map("user_id")
  action      String   @db.VarChar(50) // e.g. "LOGIN", "DELETE_ARTICLE"
  method      String   @db.VarChar(10) // GET, POST, PUT, DELETE
  path        String   @db.VarChar(255)
  params      String?  @db.Text
  ip          String?  @db.VarChar(45)
  location    String?  @db.VarChar(100)
  status      Int      @default(200) // HTTP Status Code or Custom Status
  error       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@map("operation_logs")
}
